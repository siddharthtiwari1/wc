###############################################################################
# WHEELCHAIR AMCL CONFIGURATION - TOP CLASS
###############################################################################
# Optimized for: RPLidar S3 (25m range, high density scans)
# Hardware: Wheelchair with excellent EKF odometry (/odometry/filtered)
# Environment: Indoor (hospitals, buildings, structured environments)
# This configuration is PRODUCTION-READY for autonomous wheelchair navigation

amcl:
  ros__parameters:

    # =========================================================================
    # FRAME CONFIGURATION - Wheelchair Frames
    # =========================================================================
    global_frame_id: "map"
    odom_frame_id: "odom"
    base_frame_id: "base_link"      # Wheelchair standard frame

    # Transform management
    tf_broadcast: true               # Publish map→odom transform
    transform_tolerance: 0.3         # 300ms tolerance (relaxed for safety)

    # =========================================================================
    # PARTICLE FILTER - Wheelchair-Optimized
    # =========================================================================
    # More particles than small robots due to wheelchair's larger size
    # and need for higher precision in human environments

    min_particles: 800               # Higher than standard (500)
    max_particles: 3500              # Higher than standard (2000)

    # KLD sampling - Adaptive particle count
    kld_err: 0.02                    # Max error (lower = more particles when uncertain)
    kld_z: 0.99                      # Confidence level (99%)

    # Resampling
    resample_interval: 1             # Resample every update (most responsive)
    selective_resampling: false      # Always resample for consistency

    # =========================================================================
    # UPDATE THRESHOLDS - When to Update Particle Filter
    # =========================================================================
    # Lower thresholds = more updates = better tracking but more CPU
    # Your wheelchair has good odometry, so can afford frequent updates

    update_min_d: 0.20               # Update after 20cm movement
    update_min_a: 0.15               # Update after ~8.6° rotation

    # =========================================================================
    # LASER SCAN PARAMETERS - Optimized for RPLidar S3
    # =========================================================================
    scan_topic: scan                 # Laser scan topic

    # Sensor model - likelihood_field is BEST for dense scans like S3
    laser_model_type: "likelihood_field"  # vs "beam" model

    # Range limits - Match your RPLidar S3
    laser_max_range: 20.0            # 20m effective range (S3 max = 25m)
    laser_min_range: 0.15            # Ignore readings below 15cm

    # Beam subsampling - S3 has ~16000 samples, subsample intelligently
    max_beams: 100                   # Use 100 beams (higher than standard 60)
    # This leverages S3's high density without excessive computation

    # Likelihood field parameters
    laser_likelihood_max_dist: 2.5   # Max distance for obstacle likelihood
    laser_sigma_hit: 0.15            # Std dev of hit (15cm - tight for S3)

    # Measurement weights - How much to trust different aspects
    z_hit: 0.90                      # 90% weight to correct measurements (high quality S3)
    z_rand: 0.08                     # 8% random noise (low for indoor)
    z_max: 0.01                      # 1% max range returns
    z_short: 0.01                    # 1% short measurements

    # Beam skip (for computational efficiency) - disabled for quality
    do_beamskip: false               # Don't skip beams (S3 is high quality)
    beam_skip_distance: 0.5
    beam_skip_threshold: 0.3
    beam_skip_error_threshold: 0.9

    # =========================================================================
    # MOTION MODEL - Differential Drive (Wheelchair)
    # =========================================================================
    robot_model_type: "nav2_amcl::DifferentialMotionModel"

    # Odometry noise parameters - Your EKF is GOOD, so low noise values
    # These describe how much to trust your /odometry/filtered

    # Format: rotation from rotation, rotation from translation,
    #         translation from translation, translation from rotation

    alpha1: 0.08                     # Rotation noise from rotation (low - good IMU)
    alpha2: 0.08                     # Rotation noise from translation
    alpha3: 0.15                     # Translation noise from translation (wheels can slip)
    alpha4: 0.08                     # Translation noise from rotation
    alpha5: 0.08                     # Translation noise (for diff-corrected model)

    # These values are LOWER than typical because your EKF is excellent!

    # =========================================================================
    # INITIAL POSE - Startup Configuration
    # =========================================================================
    set_initial_pose: false          # Don't auto-set (use RViz or service call)

    # If set_initial_pose is true, use these:
    initial_pose:
      x: 0.0
      y: 0.0
      z: 0.0
      yaw: 0.0

    # Initial covariance (uncertainty) - wheelchair starting pose
    initial_cov_xx: 0.25             # ±50cm in X
    initial_cov_yy: 0.25             # ±50cm in Y
    initial_cov_aa: 0.26             # ±30° in yaw (~0.52 rad)
    initial_cov_xy: 0.0
    initial_cov_xa: 0.0
    initial_cov_ya: 0.0

    # =========================================================================
    # RECOVERY / KIDNAPPED ROBOT
    # =========================================================================
    # Wheelchair might be manually moved (rare but possible)
    # These parameters help AMCL recover automatically

    recovery_alpha_slow: 0.001       # Long-term average decay (slow)
    recovery_alpha_fast: 0.05        # Short-term average decay (fast)
    # When fast/slow ratio drops below threshold, add random particles

    # =========================================================================
    # LOCALIZATION QUALITY / CONVERGENCE
    # =========================================================================
    # Particle filter error
    pf_err: 0.04                     # Target error (4% - tighter than 5% standard)
    pf_z: 0.99                       # Confidence (99%)

    # Save pose periodically
    save_pose_rate: 0.5              # Save pose every 0.5 seconds

    # =========================================================================
    # COMPUTATIONAL PERFORMANCE
    # =========================================================================
    # Use simulation time
    use_sim_time: false              # Set to true when using Gazebo

    # Spatial resolution for particle binning
    spatial_resolution_x: 0.04       # 4cm resolution (fine)
    spatial_resolution_y: 0.04       # 4cm resolution (fine)
    spatial_resolution_theta: 0.087  # ~5° angular resolution

    # Always reset initial pose
    always_reset_initial_pose: false

    # First map only
    first_map_only: false            # Allow map updates during run

    # GUI publishing rate (for RViz visualization)
    gui_publish_rate: 10.0           # 10Hz particle cloud publishing

    # =========================================================================
    # ADVANCED PARAMETERS
    # =========================================================================
    # Laser scan timeout
    laser_scan_timeout: 1.0          # Wait up to 1 second for scan

    # Lambda short (for short measurement model)
    lambda_short: 0.1                # Exponential decay for short

    # Random seed (-1 = random)
    random_seed: -1

    # Use quaternion (vs Euler angles)
    use_quaternion: true

    # =========================================================================
    # WHEELCHAIR-SPECIFIC NOTES
    # =========================================================================
    # Your wheelchair advantages:
    # 1. EXCELLENT odometry (EKF fusion) → Low alpha values
    # 2. HIGH-QUALITY lidar (S3) → More beams, tight sigma_hit
    # 3. STRUCTURED environment (indoor) → Low z_rand
    # 4. SMOOTH motion (not jerky) → Predictable for particle filter
    #
    # Result: AMCL should converge in 5-10 seconds with good initial pose!

    # =========================================================================
    # TUNING GUIDE
    # =========================================================================
    # If localization is TOO SLOW to converge:
    #   - Increase max_particles to 5000
    #   - Decrease update_min_d to 0.15 (more frequent updates)
    #   - Increase laser_sigma_hit to 0.20 (more forgiving)
    #
    # If localization is JITTERY (jumps around):
    #   - Increase min_particles to 1200
    #   - Decrease kld_err to 0.01 (more particles)
    #   - Decrease z_rand to 0.05 (trust scans more)
    #
    # If localization DRIFTS over time:
    #   - Check your map quality first!
    #   - Increase alpha values (if odometry is actually noisy)
    #   - Decrease laser_sigma_hit to 0.12 (stricter matching)
    #
    # If CPU usage is TOO HIGH:
    #   - Decrease max_particles to 2500
    #   - Decrease max_beams to 70
    #   - Increase update_min_d to 0.25
    #
    # For MAXIMUM ACCURACY (if CPU allows):
    #   - Increase max_particles to 5000
    #   - Increase max_beams to 120
    #   - Decrease update_min_d to 0.15
    #   - Decrease laser_sigma_hit to 0.12

    # =========================================================================
    # INTEGRATION WITH NAV2
    # =========================================================================
    # AMCL provides:
    # - /amcl_pose topic (geometry_msgs/PoseWithCovarianceStamped)
    # - /particlecloud topic (geometry_msgs/PoseArray) for visualization
    # - map→odom transform (corrects drift)
    #
    # Nav2 uses these for:
    # - Global planning (needs map frame)
    # - Local planning (uses latest pose)
    # - Recovery behaviors (uses covariance)
    #
    # Set initial pose via:
    # - RViz: "2D Pose Estimate" tool
    # - Topic: /initialpose
    # - Service: /reinitialize_global_localization (searches entire map)
