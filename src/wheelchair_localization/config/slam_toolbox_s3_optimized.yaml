slam_toolbox:
  ros__parameters:
    # ROS Parameters
    odom_frame: odom
    map_frame: map
    base_frame: base_link
    scan_topic: /scan
    use_map_saver: true
    mode: mapping

    # Solver Parameters
    solver_plugin: solver_plugins::CeresSolver
    ceres_linear_solver: SPARSE_NORMAL_CHOLESKY
    ceres_preconditioner: SCHUR_JACOBI
    ceres_trust_strategy: LEVENBERG_MARQUARDT
    ceres_dogleg_type: TRADITIONAL_DOGLEG
    ceres_loss_function: None

    # ============================================================================
    # RPLIDAR S3 OPTIMIZED CONFIGURATION
    # ============================================================================
    # S3 Specs: 40m range, 20Hz scan rate, 32k samples/s, 0.225° resolution
    # Strategy: Use S3's density & range while maintaining stable scan matching
    # ============================================================================

    debug_logging: false
    throttle_scans: 1  # Process every scan (S3 is 20Hz, plenty fast)
    transform_publish_period: 0.02  # 50Hz TF updates

    # MAP UPDATE RATE - Balance between responsiveness and stability
    # S3's 20Hz rate allows faster updates than A1 (5.5Hz)
    # Conservative: 5.0 | Moderate: 2.0 | Aggressive: 1.0
    map_update_interval: 2.0  # 2x faster than bumperbot, utilizing S3's speed

    resolution: 0.05  # 5cm grid - good balance for indoor/outdoor

    # LASER RANGE - Leverage S3's superior range without noise
    # S3's 40m range is excellent, but quality degrades >15m indoors
    # Conservative: 12.0 | Moderate: 20.0 | Aggressive: 30.0 | Max: 40.0
    max_laser_range: 20.0  # Sweet spot: 66% longer than A1, avoids distant noise

    # SCAN PROCESSING TIMING - Use S3's high scan rate
    # S3 at 20Hz gives scans every 50ms, so we can process faster
    # Conservative: 0.5 | Moderate: 0.3 | Aggressive: 0.2
    minimum_time_interval: 0.3  # Faster than bumperbot (0.5s), using S3's 20Hz

    transform_timeout: 0.2
    tf_buffer_duration: 30.0
    stack_size_to_use: 40000000
    enable_interactive_mode: true

    # SCAN QUEUE - Handle S3's dense data stream
    # S3 produces 4x more points than A1, needs larger queue
    # Conservative: 10 | Moderate: 20 | High density: 30
    scan_queue_size: 20  # 2x bumperbot, handles S3's density

    # ============================================================================
    # MOVEMENT THRESHOLDS - CRITICAL FOR STABLE MAPPING
    # ============================================================================
    # These determine when to process a new scan
    # Too small = poor scan matching, too large = slow map updates
    #
    # TUNING GUIDE based on your environment:
    # - Large open spaces (warehouses, outdoor): DECREASE (0.3-0.4m, 0.3-0.4 rad)
    # - Indoor with furniture/obstacles: MODERATE (0.4-0.5m, 0.4-0.5 rad)
    # - Narrow hallways/corridors: INCREASE (0.5-0.6m, 0.5-0.6 rad)
    # ============================================================================

    use_scan_matching: true
    use_scan_barycenter: true

    # DISTANCE THRESHOLD - How far robot moves before processing scan
    # S3's dense scans can handle slightly smaller thresholds than A1
    # Start: 0.5 | Good features: 0.4 | Excellent features: 0.3 | Min stable: 0.25
    minimum_travel_distance: 0.4  # Slightly tighter than bumperbot (0.5), uses S3 density

    # ROTATION THRESHOLD - How much robot rotates before processing scan
    # S3's fine angular resolution (0.225°) enables better rotation tracking
    # Start: 0.5 rad | Good features: 0.4 | Excellent features: 0.3 | Min: 0.25
    minimum_travel_heading: 0.4  # Slightly tighter, leveraging S3's resolution

    # SCAN BUFFER - Utilize S3's dense point clouds
    # S3 has ~1,600 points/scan vs A1's ~360, needs larger buffer
    # Conservative: 10 | Moderate: 15 | S3 optimized: 20 | Max: 25
    scan_buffer_size: 20  # 2x bumperbot, stores S3's rich scan history

    # SCAN BUFFER RANGE - Use S3's extended reliable range
    # Conservative: 10.0 | Moderate: 15.0 | Aggressive: 20.0
    scan_buffer_maximum_scan_distance: 15.0  # 50% more than bumperbot

    # SCAN MATCHING QUALITY - Leverage S3's accuracy
    # Lower = more permissive, higher = more strict matching
    # Permissive: 0.08 | Moderate: 0.1 | Strict: 0.15
    link_match_minimum_response_fine: 0.1  # Good quality threshold for S3

    # LINK SCAN SEARCH - S3's density allows larger search
    # Conservative: 1.5 | Moderate: 2.0 | Aggressive: 2.5
    link_scan_maximum_distance: 2.0  # Moderate search using S3's range

    # ============================================================================
    # LOOP CLOSURE - Leverage S3's long-range accuracy
    # ============================================================================
    do_loop_closing: true

    # LOOP SEARCH DISTANCE - S3's 20m usable range enables distant loop closure
    # A1 setting: 3.0 | Moderate: 5.0 | S3 optimized: 8.0 | Aggressive: 12.0
    loop_search_maximum_distance: 8.0  # 2.6x larger than bumperbot, uses S3 range

    loop_match_minimum_chain_size: 10
    loop_match_maximum_variance_coarse: 3.0
    loop_match_minimum_response_coarse: 0.35
    loop_match_minimum_response_fine: 0.45

    # ============================================================================
    # CORRELATION SEARCH - Optimize for S3's dense, accurate scans
    # ============================================================================
    # S3's high point density improves correlation matching

    # CORRELATION DIMENSION - Search space for scan matching
    # Conservative: 0.5 | Moderate: 0.8 | S3 optimized: 1.0 | Aggressive: 1.5
    correlation_search_space_dimension: 0.8  # Larger than bumperbot (0.5)

    correlation_search_space_resolution: 0.01  # Fine resolution for S3's accuracy

    # SMEAR DEVIATION - How much to "blur" scans for matching
    # Lower = stricter, higher = more permissive
    # S3's accuracy allows lower values: 0.05-0.10
    correlation_search_space_smear_deviation: 0.08  # Tighter for S3's accuracy

    # ============================================================================
    # LOOP CLOSURE SEARCH SPACE - Use S3's extended range
    # ============================================================================

    # LOOP DIMENSION - Area to search for loop closures
    # A1: 8.0 | Moderate: 12.0 | S3 optimized: 15.0 | Max: 20.0
    loop_search_space_dimension: 12.0  # 50% larger than bumperbot, using S3 range

    loop_search_space_resolution: 0.05
    loop_search_space_smear_deviation: 0.03

    # Scan Matcher Parameters
    distance_variance_penalty: 0.5
    angle_variance_penalty: 1.0

    fine_search_angle_offset: 0.00349
    coarse_search_angle_offset: 0.349
    coarse_angle_resolution: 0.0349
    minimum_angle_penalty: 0.9
    minimum_distance_penalty: 0.5
    use_response_expansion: true

    # QoS OVERRIDES
    qos_overrides:
      /scan:
        subscription:
          reliability: reliable
          history: keep_last
          depth: 10  # Increased for S3's high rate
          durability: volatile
