###############################################################################
# WHEELCHAIR SLAM TOOLBOX CONFIGURATION - TOP CLASS
###############################################################################
# Optimized for: RPLidar S3 (25m range, 0.25° resolution, 16000 samples/s)
# Hardware: Wheelchair with RealSense D455 IMU + EKF fusion
# This configuration leverages your SUPERIOR hardware vs standard robots
# Status: Production-ready, hospital/indoor navigation optimized

slam_toolbox:
  ros__parameters:

    # =========================================================================
    # SOLVER CONFIGURATION - Ceres for High Accuracy
    # =========================================================================
    solver_plugin: solver_plugins::CeresSolver
    ceres_linear_solver: SPARSE_NORMAL_CHOLESKY  # Fast + accurate for 2D
    ceres_preconditioner: SCHUR_JACOBI           # Excellent convergence
    ceres_trust_strategy: LEVENBERG_MARQUARDT    # Robust optimization
    ceres_dogleg_type: TRADITIONAL_DOGLEG
    ceres_loss_function: HuberLoss               # Robust to outliers (better than None)

    # =========================================================================
    # FRAME CONFIGURATION - Wheelchair Frames
    # =========================================================================
    odom_frame: odom
    map_frame: map
    base_frame: base_link          # Wheelchair standard frame
    scan_topic: /scan              # RPLidar S3 topic
    use_map_saver: true
    mode: mapping                  # mapping or localization

    # =========================================================================
    # RPLIDAR S3 OPTIMIZATION - Leverage 25m Range + High Resolution
    # =========================================================================
    max_laser_range: 20.0          # Use 20m effective (S3 max = 25m, conservative)
    resolution: 0.04               # 4cm resolution (better than standard 5cm)
    minimum_time_interval: 0.05    # 50ms = 20Hz (S3 can handle this easily)

    # Update thresholds - More frequent due to accurate sensors
    minimum_travel_distance: 0.25  # 25cm (vs 0.5m standard) - denser mapping
    minimum_travel_heading: 0.20   # ~11.5° (vs 0.5 rad = 28° standard)

    # Transform publishing - High rate for Nav2
    transform_publish_period: 0.02 # 50 Hz (very smooth for navigation)
    transform_timeout: 0.2
    tf_buffer_duration: 30.0

    # Map update - Balance between quality and CPU
    map_update_interval: 3.0       # 3 seconds (good balance)

    # =========================================================================
    # SCAN MATCHING - Leverage RPLidar S3's 0.25° Resolution
    # =========================================================================
    use_scan_matching: true
    use_scan_barycenter: true

    # Scan buffer - Larger for better loop closure
    scan_buffer_size: 20           # Keep 20 scans (vs 10 standard)
    scan_buffer_maximum_scan_distance: 18.0  # Within S3's reliable range

    # Matching thresholds - Stricter due to high-quality scans
    link_match_minimum_response_fine: 0.15   # Stricter than 0.1 (good scans)
    link_scan_maximum_distance: 2.0          # Max distance between scans

    # =========================================================================
    # LOOP CLOSURE - Critical for Large Environments (Hospital Hallways)
    # =========================================================================
    do_loop_closing: true          # ESSENTIAL for wheelchair navigation

    # Search parameters - Larger due to wheelchair's longer travel distances
    loop_search_maximum_distance: 5.0  # 5m radius (hospitals have long halls)
    loop_match_minimum_chain_size: 12  # Require 12 scans for closure (robust)

    # Loop quality thresholds - Balanced for reliability
    loop_match_maximum_variance_coarse: 2.0   # Stricter than 3.0
    loop_match_minimum_response_coarse: 0.40  # Good quality required
    loop_match_minimum_response_fine: 0.50    # High quality for final match

    # =========================================================================
    # CORRELATION SEARCH SPACE - Scan Matching Parameters
    # =========================================================================
    # For consecutive scan matching
    correlation_search_space_dimension: 0.4   # ±40cm search window
    correlation_search_space_resolution: 0.008  # 8mm resolution (very fine!)
    correlation_search_space_smear_deviation: 0.08

    # For loop closure matching (larger area)
    loop_search_space_dimension: 8.0          # ±8m search window
    loop_search_space_resolution: 0.04        # 4cm resolution
    loop_search_space_smear_deviation: 0.025  # Tight for accuracy

    # =========================================================================
    # SCAN MATCHER PENALTIES - Prevent Bad Matches
    # =========================================================================
    distance_variance_penalty: 0.4   # Penalize distance uncertainty
    angle_variance_penalty: 1.2      # Penalize angle uncertainty more

    # Search resolution
    fine_search_angle_offset: 0.00349      # 0.2° (leverage S3's resolution)
    coarse_search_angle_offset: 0.349      # 20°
    coarse_angle_resolution: 0.0349        # 2°

    # Match quality
    minimum_angle_penalty: 0.9
    minimum_distance_penalty: 0.5
    use_response_expansion: true

    # =========================================================================
    # PERFORMANCE TUNING
    # =========================================================================
    debug_logging: false
    throttle_scans: 1              # Process every scan (S3 can handle it)
    stack_size_to_use: 40000000    # 40MB for large maps
    enable_interactive_mode: true  # Allow RViz interaction

    # =========================================================================
    # WHEELCHAIR-SPECIFIC OPTIMIZATIONS
    # =========================================================================
    # Wheelchairs move differently than small robots:
    # - Smoother motions (less jerky)
    # - Longer straight-line segments
    # - Precise turns (good odometry)
    # - Indoor environments (consistent lighting, structured)

    # These parameters leverage those characteristics:
    optimization_step_size: 2      # Optimize every 2 nodes (balanced)

    # =========================================================================
    # ADVANCED FEATURES
    # =========================================================================
    # Map saving/loading (for continued mapping sessions)
    # map_file_name: /path/to/saved/map  # Uncomment to load previous map
    # map_start_pose: [0.0, 0.0, 0.0]    # Starting pose if loading map

    # =========================================================================
    # TUNING NOTES FOR YOUR WHEELCHAIR
    # =========================================================================
    # 1. If maps are TOO DETAILED (too much noise):
    #    - Increase minimum_travel_distance to 0.3
    #    - Increase correlation_search_space_resolution to 0.01
    #
    # 2. If LOOP CLOSURE is missed (map drifts in large areas):
    #    - Increase loop_search_maximum_distance to 6.0 or 7.0
    #    - Decrease loop_match_minimum_response_fine to 0.45
    #
    # 3. If CPU usage is too HIGH:
    #    - Increase map_update_interval to 5.0
    #    - Set throttle_scans to 2 (process every 2nd scan)
    #    - Increase minimum_travel_distance to 0.3
    #
    # 4. If you want MAXIMUM ACCURACY (slower):
    #    - Decrease resolution to 0.03 (3cm per pixel)
    #    - Decrease minimum_travel_distance to 0.2
    #    - Increase scan_buffer_size to 25
    #
    # Your EKF odometry is excellent, so SLAM should work beautifully!
