### ekf_global config file ###
### This EKF fuses local odometry with SLAM corrections for drift-free global pose

ekf_global_node:
  ros__parameters:
    frequency: 30.0
    two_d_mode: true
    publish_tf: true
    publish_acceleration: false

    # Frame configuration
    map_frame: map
    odom_frame: odom
    base_link_frame: base_link
    world_frame: map  # Use map as world frame for global localization

    # Input 1: Local EKF odometry (wheels + IMU)
    # High frequency, smooth, but drifts over time
    odom0: /odometry/filtered
    odom0_config: [false, false, false,    # Don't fuse position (gets corrected by SLAM)
                   false, false, false,    # Don't fuse orientation (gets corrected by SLAM)
                   true,  false, false,    # Fuse vx velocity (accurate short-term)
                   false, false, true,     # Fuse yaw velocity (accurate short-term)
                   false, false, false]    # No acceleration
    odom0_differential: false
    odom0_relative: false
    odom0_queue_size: 10

    # Input 2: SLAM pose (from slam_toolbox)
    # Lower frequency but drift-free global corrections
    pose0: /slam_toolbox/pose
    pose0_config: [true,  true,  false,    # Fuse x, y position from SLAM
                   false, false, true,     # Fuse yaw from SLAM
                   false, false, false,    # No velocities from SLAM
                   false, false, false,    # No angular velocities
                   false, false, false]    # No acceleration
    pose0_differential: false
    pose0_relative: false
    pose0_queue_size: 5

    # Process noise - balanced for global localization
    # Lower than local EKF because we have absolute position corrections
    process_noise_covariance: [0.01,  0.0,   0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,   0.01,  0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,   0.0,   0.06,   0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,   0.0,   0.0,    0.03,   0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,   0.0,   0.0,    0.0,    0.03,   0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,   0.0,   0.0,    0.0,    0.0,    0.01,   0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.02,    0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,     0.02,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.04,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.01,   0.0,    0.0,    0.0,    0.0,    0.0,
                               0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.01,   0.0,    0.0,    0.0,    0.0,
                               0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.01,   0.0,    0.0,    0.0,
                               0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.01,   0.0,    0.0,
                               0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.01,   0.0,
                               0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.01]

    # Initial covariance
    initial_estimate_covariance: [1e-3,  0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                  0.0,   1e-3,  0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                  0.0,   0.0,   1e-3,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                  0.0,   0.0,   0.0,    1e-3,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                  0.0,   0.0,   0.0,    0.0,    1e-3,   0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                  0.0,   0.0,   0.0,    0.0,    0.0,    1e-3,   0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                  0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    1e-3,   0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                  0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    1e-3,   0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                  0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    1e-3,   0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                  0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    1e-3,    0.0,     0.0,     0.0,    0.0,    0.0,
                                  0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     1e-3,    0.0,     0.0,    0.0,    0.0,
                                  0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     1e-3,    0.0,    0.0,    0.0,
                                  0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     1e-3,   0.0,    0.0,
                                  0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    1e-3,   0.0,
                                  0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    1e-3]
