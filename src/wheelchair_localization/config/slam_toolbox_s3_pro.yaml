slam_toolbox:
  ros__parameters:
    # ROS Parameters
    odom_frame: odom
    map_frame: map
    base_frame: base_link
    scan_topic: /scan
    use_map_saver: true
    mode: mapping

    # Solver Parameters - High quality optimization
    solver_plugin: solver_plugins::CeresSolver
    ceres_linear_solver: SPARSE_NORMAL_CHOLESKY
    ceres_preconditioner: SCHUR_JACOBI
    ceres_trust_strategy: LEVENBERG_MARQUARDT
    ceres_dogleg_type: TRADITIONAL_DOGLEG
    ceres_loss_function: None

    # ============================================================================
    # RPLIDAR S3 PRO CONFIGURATION - ACTUAL DATASHEET SPECS
    # ============================================================================
    # Hardware Specs (from official datasheet):
    #   - Range: 40m (white/70% reflectivity), 15m (black/10%), 5m (2%)
    #   - Scan Rate: Typical 10Hz, adjustable 10-20Hz
    #   - Sample Rate: 32 kHz
    #   - Angular Resolution: Typical 0.1125°, range 0.1125°-0.225°
    #   - Points per Scan: ~3,200 points at 10Hz, ~1,600 at 20Hz
    #   - Accuracy: ±30mm
    #   - Daylight Resistance: ≥80Klux
    #
    # Configuration Strategy:
    #   ✓ Match S3's typical 10Hz scan rate (perfect sync)
    #   ✓ Fix fast motion/turn failures (10° rotation threshold)
    #   ✓ Use all 3,200 points per scan (zero waste)
    #   ✓ 25m range (safe for mixed indoor surfaces)
    #   ✓ Professional 3cm resolution maps
    # ============================================================================

    debug_logging: false

    # SCAN PROCESSING - Use EVERY scan from S3's typical 10Hz stream
    throttle_scans: 1  # Process all scans = all 3,200 points/scan used!

    # TF PUBLISHING - Maximum responsiveness
    transform_publish_period: 0.02  # 50Hz updates

    # MAP UPDATE RATE - AGGRESSIVE for real-time mapping
    # Conservative: 2.0 | Moderate: 1.0 | AGGRESSIVE: 0.5
    map_update_interval: 0.5  # Update map 2x per second!

    # MAP RESOLUTION - High quality with S3's accuracy
    # Standard: 0.05 | High quality: 0.03 | Ultra: 0.02
    resolution: 0.03  # 3cm resolution - next level detail!

    # LASER RANGE - Balanced for mixed indoor surfaces
    # Per datasheet: 40m (white 70%), 15m (black 10%), 5m (dark 2%)
    # Indoor optimal: 20m | Mixed: 25m | White walls: 30-35m | Max: 40m
    max_laser_range: 25.0  # Safe default for mixed surfaces (increase to 30-35 for white walls)

    # ============================================================================
    # FIX: FAST MOTION & TURN FAILURES
    # ============================================================================
    # Problem: Old config minimum_time_interval: 0.5s was too slow
    # - Old: Waited 500ms between scans = threw away 80% of S3 data!
    # - During fast 90° turn: Only 3 updates = SLAM lost tracking
    #
    # Solution: Match S3's typical 10Hz scan rate for perfect sync
    # ============================================================================

    # MINIMUM TIME BETWEEN SCANS - CRITICAL FOR TURNS!
    # S3's typical scan rate: 10Hz (scan every 100ms)
    # Conservative: 0.2s (5Hz) | Moderate: 0.15s | OPTIMAL: 0.1s (10Hz) | Max: 0.05s (20Hz)
    minimum_time_interval: 0.1  # Perfect sync with S3's 10Hz typical rate!

    transform_timeout: 0.2
    tf_buffer_duration: 30.0
    stack_size_to_use: 40000000
    enable_interactive_mode: true

    # SCAN QUEUE - Handle S3's dense 10Hz stream with 3,200 points/scan
    scan_queue_size: 30  # Stores 30 scans × 3,200 pts = 96,000 points!

    # ============================================================================
    # MOVEMENT THRESHOLDS - SOLVE TURN FAILURES
    # ============================================================================
    # Current problem:
    #   minimum_travel_distance: 0.5m - Robot barely moves during rotation!
    #   minimum_travel_heading: 0.5 rad (28.6°) - Huge angle between updates
    #   Result: SLAM loses tracking during fast turns
    #
    # S3 Pro solution: AGGRESSIVE thresholds for smooth tracking
    # ============================================================================

    use_scan_matching: true
    use_scan_barycenter: true

    # DISTANCE THRESHOLD - Very low for turn tracking
    # Default: 0.5 | Moderate: 0.3 | AGGRESSIVE: 0.2 | Ultra: 0.15
    # During turns, robot moves very little linearly - need low threshold
    minimum_travel_distance: 0.2  # Trigger on minimal motion

    # ROTATION THRESHOLD - THE KEY TO FIXING TURNS!
    # Default: 0.5 rad (28.6°) - TERRIBLE for fast turns
    # Moderate: 0.3 rad (17.2°)
    # AGGRESSIVE: 0.17 rad (10°) - Update every 10° of rotation!
    # Ultra: 0.087 rad (5°) - Maximum tracking
    #
    # With 0.17 rad: 90° turn = 9 scan updates vs 3 updates before!
    minimum_travel_heading: 0.17  # 10° rotation threshold - SMOOTH TURNS!

    # SCAN BUFFER - Leverage S3's ultra-dense point clouds
    # S3 at 10Hz: 3,200 points/scan (at 20Hz: 1,600 points/scan)
    scan_buffer_size: 30  # Store 30 × 3,200 = 96,000 points of history!
    scan_buffer_maximum_scan_distance: 20.0  # Use S3's range

    # SCAN MATCHING QUALITY - Strict with S3's accuracy
    # S3's dense scans provide excellent features
    # Permissive: 0.08 | Moderate: 0.1 | STRICT: 0.12
    link_match_minimum_response_fine: 0.12  # Demand quality with S3

    # LINK SCAN SEARCH - Large search for fast motion
    # Conservative: 2.0 | Moderate: 2.5 | AGGRESSIVE: 3.0
    link_scan_maximum_distance: 3.0  # Handle large inter-scan motion

    # ============================================================================
    # LOOP CLOSURE - Exploit S3's 40m range
    # ============================================================================
    do_loop_closing: true

    # LOOP SEARCH DISTANCE - S3's 25m reliable range enables distant loops
    # A1: 3m | Moderate: 8m | S3 AGGRESSIVE: 15m | Max: 20m
    loop_search_maximum_distance: 15.0  # 5x better than basic configs!

    loop_match_minimum_chain_size: 10
    loop_match_maximum_variance_coarse: 3.0

    # Loop closure quality - strict with S3's data
    loop_match_minimum_response_coarse: 0.40  # High quality
    loop_match_minimum_response_fine: 0.50     # Very strict

    # ============================================================================
    # CORRELATION SEARCH - Handle fast motion with large search space
    # ============================================================================
    # During fast motion, robot pose changes significantly between scans
    # Need large search space to find correct match

    # CORRELATION DIMENSION - Search area for scan matching
    # Default: 0.5 | Moderate: 0.8 | AGGRESSIVE: 1.5 | Fast motion: 2.0
    # During fast motion, robot can move >1m between scans
    correlation_search_space_dimension: 1.5  # Large search for fast motion

    # RESOLUTION - Fine resolution with S3's accuracy
    correlation_search_space_resolution: 0.01  # 1cm precision

    # SMEAR DEVIATION - S3's accuracy allows tight tolerance
    # High: 0.1 | Moderate: 0.08 | TIGHT: 0.06
    correlation_search_space_smear_deviation: 0.06  # Precise matching

    # ============================================================================
    # LOOP CLOSURE SEARCH SPACE - Maximize S3's range advantage
    # ============================================================================

    # LOOP DIMENSION - Huge search space for S3's 25m range
    # Default: 8.0 | Moderate: 12.0 | S3 AGGRESSIVE: 18.0
    loop_search_space_dimension: 18.0  # Massive loop closure area!

    loop_search_space_resolution: 0.05
    loop_search_space_smear_deviation: 0.03

    # ============================================================================
    # SCAN MATCHER PARAMETERS - Optimized for quality
    # ============================================================================

    # VARIANCE PENALTIES - Balanced for S3's quality
    distance_variance_penalty: 0.5  # Standard
    angle_variance_penalty: 1.0     # Standard

    # ANGLE SEARCH - Fine angular search matching S3's actual 0.1125° resolution
    fine_search_angle_offset: 0.00196     # 0.1125° - matches S3's typical resolution!
    coarse_search_angle_offset: 0.349     # ~20°
    coarse_angle_resolution: 0.0349       # ~2°

    # PENALTIES - Strict for quality maps
    minimum_angle_penalty: 0.9
    minimum_distance_penalty: 0.5

    use_response_expansion: true

    # ============================================================================
    # QoS OVERRIDES - Ensure reliable delivery of S3's data stream
    # ============================================================================
    qos_overrides:
      /scan:
        subscription:
          reliability: reliable
          history: keep_last
          depth: 20  # Large queue for 20Hz stream
          durability: volatile
