# ============================================================================
# WHEELCHAIR-SPECIFIC SENSOR FUSION CONFIGURATION
# ============================================================================
# Optimized for indoor navigation with safety-first approach
# Hardware: RPLidar S3, RealSense D455, Differential Drive Base
# Environment: Hospitals, offices, homes, corridors
# Robot radius: 0.4m | Max velocity: 0.5 m/s
# ============================================================================

lidar_processor:
  ros__parameters:
    # Topics - integrated with existing wheelchair system
    scan_topic: '/scan'                  # RPLidar S3 topic
    clusters_topic: '/lidar/clusters'
    visualization_topic: '/lidar/clusters_viz'

    # Range limits for INDOOR operation (wheelchair-specific)
    min_range: 0.15                      # 15cm minimum (wheelchair clearance)
    max_range: 6.0                       # 6m maximum (indoor spaces)

    # DBSCAN clustering - tuned for indoor obstacles
    dbscan_eps: 0.15                     # 15cm cluster radius (tight for furniture)
    dbscan_min_samples: 3                # Minimum 3 points per obstacle

    # Cluster filtering - remove noise
    min_cluster_size: 3                  # Minimum cluster size
    max_cluster_size: 100                # Maximum cluster size

    # Publishing rate
    publish_rate: 20.0                   # Match LiDAR rate

# ----------------------------------------------------------------------------
# YOLO DETECTOR - Semantic understanding for indoor navigation
# ----------------------------------------------------------------------------
yolo_detector:
  ros__parameters:
    # Topics
    image_topic: '/camera/color/image_raw'
    camera_info_topic: '/camera/color/camera_info'
    detections_topic: '/yolo/detections'
    debug_image_topic: '/yolo/debug_image'

    # Model configuration
    model_path: 'yolov11n.pt'            # Nano model for real-time performance
    confidence_threshold: 0.5            # 50% confidence minimum
    iou_threshold: 0.45                  # NMS IoU threshold
    device: 'cuda'                       # GPU acceleration (CPU fallback available)
    img_size: 640                        # Input size

    # Publishing
    publish_debug_image: true            # Enable debug visualization

    # Target classes for INDOOR wheelchair navigation
    # Empty list = all classes, or specify: [0, 56, 57, 62]
    # 0=person, 56=chair, 57=couch, 62=tv, etc.
    target_classes: []                   # Detect all objects

# ----------------------------------------------------------------------------
# ROBUST SENSOR FUSION - Production-grade adaptive fusion
# ----------------------------------------------------------------------------
sensor_fusion_robust:
  ros__parameters:
    # Input topics - integrated with wheelchair sensor stack
    lidar_clusters_topic: '/lidar/clusters'
    yolo_detections_topic: '/yolo/detections'
    camera_info_topic: '/camera/color/camera_info'
    depth_image_topic: '/camera/aligned_depth_to_color/image_raw'
    scan_topic: '/scan'                  # Fallback topic

    # Output topics - integrated with Nav2
    fused_obstacles_topic: '/fusion/obstacles'
    visualization_topic: '/fusion/visualization'
    costmap_topic: '/fusion/obstacle_costmap'
    diagnostics_topic: '/fusion/diagnostics'
    status_topic: '/fusion/status'

    # Fusion algorithm parameters
    fusion_iou_threshold: 0.3            # IoU threshold for LiDAR-camera matching
    max_association_distance: 0.5        # Maximum distance for association (meters)
    adaptive_weighting: true             # Enable adaptive weight adjustment
    distance_threshold: 2.0              # Distance for LiDAR/camera weight transition
    lighting_adaptive: true              # Adapt to lighting conditions

    # INDOOR-SPECIFIC OPTIMIZATIONS
    indoor_mode: true                    # Enable indoor-specific processing
    max_obstacle_distance: 6.0           # Maximum obstacle range (indoor)
    min_obstacle_distance: 0.15          # Minimum obstacle range (wheelchair clearance)
    obstacle_inflation: 0.3              # Safety margin for wheelchair (meters)

    # Robustness features - CRITICAL for wheelchair safety
    enable_tracking: true                # Multi-frame obstacle tracking
    tracking_distance_threshold: 0.5     # Tracking association distance
    min_obstacle_confidence: 0.3         # Minimum confidence to report obstacle
    sensor_timeout: 1.0                  # Sensor timeout (seconds)
    enable_fallback: true                # Enable automatic fallback modes

    # Frame IDs - must match wheelchair URDF
    lidar_frame: 'lidar'
    camera_frame: 'camera_color_optical_frame'
    base_frame: 'base_link'

    # Synchronization - tuned for wheelchair sensor rates
    sync_queue_size: 10
    sync_slop: 0.1                       # 100ms tolerance for sync

    # Costmap generation for Nav2 integration
    costmap_resolution: 0.05             # 5cm resolution (matches Nav2 local costmap)
    costmap_width: 10.0                  # 10m width
    costmap_height: 10.0                 # 10m height

# ----------------------------------------------------------------------------
# OBSTACLE PUBLISHER - Nav2 Integration
# ----------------------------------------------------------------------------
obstacle_publisher:
  ros__parameters:
    # Topics
    obstacles_topic: '/fusion/obstacles'
    costmap_topic: '/fusion/obstacle_costmap'

    # Costmap parameters - MUST match Nav2 local costmap
    grid_resolution: 0.05                # 5cm resolution (Nav2 standard)
    grid_width: 10.0                     # 10m x 10m local window
    grid_height: 10.0
    obstacle_inflation: 0.3              # Wheelchair safety margin

# ============================================================================
# INTEGRATION NOTES
# ============================================================================
#
# 1. This configuration integrates with existing wheelchair Nav2 setup
# 2. Fused costmap published to /fusion/obstacle_costmap
# 3. Add as obstacle layer in Nav2 local costmap configuration:
#
#    local_costmap:
#      local_costmap:
#        ros__parameters:
#          plugins: ["voxel_layer", "fusion_layer", "inflation_layer"]
#          fusion_layer:
#            plugin: "nav2_costmap_2d::StaticLayer"
#            map_topic: /fusion/obstacle_costmap
#
# 4. Safety: Sensor fusion provides ADDITIONAL safety layer on top of
#    existing LiDAR-only obstacle detection in Nav2
#
# 5. Performance: Runs at 30 Hz real-time on Jetson Orin Nano or x86 + GPU
#
# 6. Fallback: If fusion fails, Nav2 still has raw LiDAR /scan as backup
#
# ============================================================================
